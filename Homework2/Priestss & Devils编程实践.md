# Homework2-ç¼–ç¨‹å®è·µ

### é¢˜ç›®è¦æ±‚

* é˜…è¯»ä»¥ä¸‹æ¸¸æˆè„šæœ¬

> Priests and Devils
Priests and Devils is a puzzle game in which you will help the Priests and Devils to cross the river within the time limit. There are 3 priests and 3 devils at one side of the river. They all want to get to the other side of this river, but there is only one boat and this boat can only carry two persons each time. And there must be one person steering the boat from one side to the other side. In the flash game, you can click on them to move them and click the go button to move the boat to the other direction. If the priests are out numbered by the devils on either side of the river, they get killed and the game is over. You can try it in many > ways. Keep all priests alive! Good luck ï¼

##### ç®€ç­”é¢˜ï¼š

* play the game ( http://www.flash-game.net/game/2535/priests-and-devils.html )
* åˆ—å‡ºæ¸¸æˆä¸­æåŠçš„äº‹ç‰©ï¼ˆObjectsï¼‰
    æ¸¸æˆä¸­æåŠçš„äº‹ç‰©æœ‰
    * é­”é¬¼
    * ç‰§å¸ˆ
    * èˆ¹
    * ä¸¤è¾¹çš„å²¸
    * æ²³
    
* ç”¨è¡¨æ ¼åˆ—å‡ºç©å®¶åŠ¨ä½œè¡¨ï¼ˆè§„åˆ™è¡¨ï¼‰ï¼Œæ³¨æ„ï¼ŒåŠ¨ä½œè¶Šå°‘è¶Šå¥½

| è¡Œä¸º | è¡Œä¸ºæ¡ä»¶ |
| --- | --- |
| ç‰§å¸ˆï¼æ¶é­”ä¸Šèˆ¹ | èˆ¹ä¸Šæœ‰ç©ºä½ä¸”èˆ¹åœ¨è¯¥å²¸ |
| å¼€èˆ¹ | èˆ¹ä¸Šæœ‰äºº |
| ç‰§å¸ˆ/æ¶é­”ä¸‹èˆ¹ | èˆ¹æœ‰äººä¸”é åœ¨å²¸è¾¹ |
| æ¸¸æˆèƒœåˆ© | 6ä¸ªäººéƒ½åˆ°äº†å¯¹å²¸ |
| æ¸¸æˆå¤±è´¥ | æœ‰ä¸€è¾¹å²¸ä¸Šäººæ•°ä¸å‡ |

##### ç¨‹åºé™åˆ¶

* è¯·å°†æ¸¸æˆä¸­å¯¹è±¡åšæˆé¢„åˆ¶
* åœ¨ GenGameObjects ä¸­åˆ›å»º é•¿æ–¹å½¢ã€æ­£æ–¹å½¢ã€çƒ åŠå…¶è‰²å½©ä»£è¡¨æ¸¸æˆä¸­çš„å¯¹è±¡ã€‚
* ä½¿ç”¨ C# é›†åˆç±»å‹ æœ‰æ•ˆç»„ç»‡å¯¹è±¡
* æ•´ä¸ªæ¸¸æˆä»… ä¸»æ‘„åƒæœº å’Œ ä¸€ä¸ª Empty å¯¹è±¡ï¼Œ å…¶ä»–å¯¹è±¡å¿…é¡»ä»£ç åŠ¨æ€ç”Ÿæˆï¼ï¼ï¼æ•´ä¸ªæ¸¸æˆä¸è®¸å‡ºç° Find æ¸¸æˆå¯¹è±¡ï¼Œ SendMessage è¿™ç±»çªç ´ç¨‹åºç»“æ„çš„ é€šè®¯è€¦åˆ è¯­å¥ã€‚ è¿èƒŒæœ¬æ¡å‡†åˆ™ï¼Œä¸ç»™åˆ†
* è¯·ä½¿ç”¨è¯¾ä»¶æ¶æ„å›¾ç¼–ç¨‹ï¼Œä¸æ¥å—é MVC ç»“æ„ç¨‹åº
* æ³¨æ„ç»†èŠ‚ï¼Œä¾‹å¦‚ï¼šèˆ¹æœªé å²¸ï¼Œç‰§å¸ˆä¸é­”é¬¼ä¸Šä¸‹èˆ¹è¿åŠ¨ä¸­ï¼Œå‡ä¸èƒ½æ¥å—ç”¨æˆ·äº‹ä»¶ï¼

---
### Unityä¸­çš„MVCæ¶æ„
æƒ³ä½¿ç”¨ä¸€ä¸ªæ¶æ„è¿›è¡Œå¼€å‘ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å…ˆäº†è§£MVCæ¶æ„å¦‚ä½•åœ¨åŸºäºUnityçš„æ¸¸æˆçš„å¼€å‘ä¸­ä½¿ç”¨ã€‚ä»”ç»†åˆ†æUnityä¸­çš„MVCç»“æ„ï¼Œç»“åˆè€å¸ˆä¸Šè¯¾æ—¶æ‰€è®²çš„å†…å®¹ï¼Œå®ƒå…¶å®å’Œå¹³æ—¶åœ¨WEBä¸­å¸¸ç”¨MVCç»“æ„åœ¨æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œéƒ½æ˜¯å…³æ³¨ç‚¹åˆ†ç¦»(SOC)çš„ä½“ç°ï¼Œæ˜¯ä¸€ç§æˆç†Ÿçš„è½¯ä»¶è®¾è®¡è§„èŒƒã€‚ä½¿ç”¨MVCæ¶æ„å»å¼€å‘æˆ‘ä»¬çš„è½¯ä»¶ï¼Œå¯ä»¥ä½¿å¾—æˆ‘ä»¬åœ¨æ‹“å±•è½¯ä»¶åŠŸèƒ½ã€æ”¹è¿›ç”¨æˆ·äº¤äº’çš„æ—¶å€™ï¼Œä¸éœ€è¦é‡å†™å¤§é‡çš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œå‡å°‘äº†æˆ‘ä»¬çš„ä»£ç é‡ï¼Œæ–¹ä¾¿äº†è½¯ä»¶çš„æ‹“å±•ï¼Œå°±å¦‚è€å¸ˆæ‰€è¯´çš„ï¼šâ€œç¨³å›ºçš„MVCæ¡†æ¶ç»å¾—èµ·ä»»æ„æ‹“å±•â€ã€‚
    
ä¸‹é¢æˆ‘ä»¬æ¥è°ˆè°ˆUnityä¸­çš„MVCæ¶æ„:

* M(Model): Unityä¸­ï¼ŒModelå°±æ˜¯æ¸¸æˆåœºæ™¯ä¸­GameObjectã€å’Œå®ƒä»¬çš„å…³ç³»ä»¥åŠåå°çš„æ•°æ®æ¨¡å‹(æ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ç­‰)ï¼Œå®ƒä»¬éƒ½å—åˆ°ç›¸åº”çš„Controllerçš„æ§åˆ¶
* V(View): Viewè¿™éƒ¨åˆ†åœ¨æ¸¸æˆä¸­èµ·åˆ°çš„æ˜¯ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œå®ƒä»¬è´Ÿè´£å‘ç”¨æˆ·æˆ˜æœ¯æ¸¸æˆç»“æœï¼Œå¤„ç†GUIäº‹ä»¶å¹¶é€šè¿‡IUserActionæ¥å£æ¥ä¸Controllerè¿›è¡Œäº¤äº’ã€‚
* C(Controller): Controlleræ§åˆ¶ç€æ¸¸æˆåœºæ™¯ä¸­æ‰€æœ‰çš„å¯¹è±¡ï¼Œå…¶è´Ÿè´£æ¥æ”¶æ¥è‡ªViewçš„ç”¨æˆ·çš„æŒ‡ä»¤å¹¶æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æŒ‡ä»¤ï¼Œæ›´æ–°Modelsä»¥åŠæ›´æ–°Viewçš„çŠ¶æ€ï¼Œå…¶å¯ä»¥è¢«è®¤ä¸ºæ˜¯è¿æ¥Modelä¸Viewçš„æ¡¥æ¢ã€‚

---
### é¡¹ç›®UMLå›¾

åœ¨äº†è§£äº†Unityä¸­MVCçš„åŸºæœ¬æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿›è¡Œä¸‹é¢çš„å¼€å‘äº†

æŒ‰ç…§é¢˜ç›®è¦æ±‚çš„MVCç»“æ„ï¼Œåˆ†ææ¸¸æˆçš„åŸºæœ¬ç»“æ„ï¼Œå¾—åˆ°åŸºæœ¬çš„UMLå›¾çš„ç»“æ„å¦‚ä¸‹:
![UML](https://zhongwq.github.io/img/GameStructure-hw2.png)

## å¯¹å„æ¨¡å—åˆ†å—è¿›è¡Œå¼€å‘
---
### GameDirector
é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å¼€å‘æ‹…è´Ÿç€ä¼—å¤šèŒè´£çš„GameDirectorï¼Œåœ¨æ¸¸æˆé‡Œé¢ï¼Œå¯¼æ¼”(Director)çš„èŒè´£å¤§è‡´å¦‚ä¸‹:

* è·å–å½“å‰æ¸¸æˆçš„åœºæ™¯
* æ§åˆ¶åœºæ™¯è¿è¡Œã€åˆ‡æ¢ã€å…¥æ ˆä¸å‡ºæ ˆï¼Œæš‚åœã€æ¢å¤ã€é€€å‡º
* ç®¡ç†æ¸¸æˆå…¨å±€çŠ¶æ€
* è®¾å®šæ¸¸æˆçš„é…ç½®
* è®¾å®šæ¸¸æˆå…¨å±€è§†å›¾

ç”±ä¸Šæˆ‘ä»¬å¯çŸ¥ï¼ŒGameDirectorå¯¹äºä¸€ä¸ªæ¸¸æˆæ˜¯å¤šä¹ˆçš„é‡è¦ï¼Œä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬è¿™æ¬¡çš„å°é¡¹ç›®ä¸­ï¼Œå®ƒçš„èŒè´£æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œå®ƒåœ¨è¿™æ¬¡çš„é¡¹ç›®ä¸­ä¸»è¦è´Ÿè´£çš„æ˜¯è·å–å½“å‰æ¸¸æˆåœºæ™¯ï¼Œå…¶ä»£ç å¦‚ä¸‹:

```c#
public class GameDirector : System.Object {
    private static GameDirector _instance;
    public ISceneController currentSceneController { get; set; }
    public bool running { set; get; }
    
    public static GameDirector getInstance()
    {
        if (_instance == null)
        {
            _instance = new GameDirector();
            return _instance;
        } 
        return _instance;
    }

    public int getFPS()
    {
        return Application.targetFrameRate;
    }

    public void setFPS(int fps)
    {
        Application.targetFrameRate = fps;        
    }
}
```
Directoråœ¨è¿è¡Œæ—¶åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹åœ¨è¿è¡Œï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶åº”ç”¨äº†å•ä¾‹æ¨¡å¼ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹ç”Ÿæˆï¼Œæ–¹ä¾¿äº†ç±»ä¹‹é—´çš„äº‹ä»¶é€šä¿¡ï¼Œæ–¹ä¾¿äº†MVCçš„å®ç°ã€‚

Directorä½œä¸ºæ¸¸æˆæœ€ä¸ºé«˜å±‚çš„Controllerï¼Œå…¶ä¸å…·ä½“çš„æ§åˆ¶æ¸¸æˆä¸­çš„ä»»ä¸€å¯¹è±¡ï¼Œå…¶é€šè¿‡å¯¹currentSceneControllerçš„ç»´æŠ¤ï¼ŒæŠŠæ§åˆ¶æ¸¸æˆå¯¹è±¡çš„ä»»åŠ¡äº¤ç»™ä¸åŒçš„SceneControllerã€‚

---
### ISceneController
ISceneControllerçš„ä»£ç å¦‚ä¸‹

```c#
//interface of Scene

public interface ISceneController
{
    void genGameObjects();
}
```
ISCeneControlleræ˜¯æ¸¸æˆä¸­çš„åœºæ™¯ç®¡ç†å™¨ï¼Œä¿—ç§°åœºè®°ï¼Œå…¶ä¸»è¦èŒè´£å¦‚ä¸‹:

* ç®¡ç†æ¸¸æˆåœ¨è¯¥æ¸¸æˆåœºæ™¯ä¸­çš„æ‰€æœ‰çš„æ¸¸æˆå¯¹è±¡
* åè°ƒæ¸¸æˆå¯¹è±¡ã€æ¸¸æˆå¯¹è±¡ç®¡ç†å™¨(GameObjectControllers)ä¹‹é—´çš„é€šä¿¡
* å“åº”å¤–éƒ¨è¾“å…¥äº‹ä»¶
* ç®¡ç†è¯¥æ¸¸æˆåœºæ™¯çš„æ‰€æœ‰çš„è§„åˆ™
* ç®¡ç†ä¸€äº›å…¶ä»–çš„ä¸œè¥¿

è¯¥ç»Ÿä¸€çš„æ¥å£çš„å®ç°æ­£æ˜¯GameDirectorå¯¹å„ä¸ªæ¸¸æˆåœºæ™¯ç®¡ç†çš„å…³é”®ï¼Œä»–æ˜¯å¯¼æ¼”æ§åˆ¶åœºæ™¯çš„æ¸ é“ï¼ŒGameDirectoré€šè¿‡å¯¹äºcurrentSceneControllerçš„ç»´æŠ¤ï¼Œå¯ä»¥ç®€å•å®ç°æ¸¸æˆåœºæ™¯çš„å„ç§ç®¡ç†

---

### IUserAction
IUserActionä¸­ä½“ç°äº†æ¸¸æˆç¼–ç¨‹çš„é—¨é¢æ¨¡å¼ï¼Œæ¸¸æˆå¤–éƒ¨ä¸ä¸€ä¸ªå­ç³»ç»Ÿçš„é€šä¿¡å¿…é¡»é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„é—¨é¢å¯¹è±¡è¿›è¡Œï¼Œè€Œæˆ‘ä»¬ç°åœ¨å®ç°çš„IUserActionå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡,GUIç±»é€šè¿‡IUserActionæ¥ä¸Controllerè¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°IUserActionæ¥å£æ¥å®šä¹‰Controllerä¸GUIçš„äº¤äº’ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å®ç°Controllerç±»æ—¶åªéœ€è¦å®ç°IUserActionå¯¹åº”çš„æ¥å£ï¼Œä»–å°±å¯ä»¥ä¸ä»»æ„ä½¿ç”¨IUserActionæ¥å£çš„Viewå³GUIç±»è°ƒç”¨ï¼ŒGUIç±»ä¹Ÿæ˜¯åªéœ€è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•å³å¯å®ç°ä¸Controllerçš„é€šä¿¡, æ–¹ä¾¿äº†æˆ‘ä»¬MVCæ¶æ„çš„å®ç°ã€‚

å…¶å®šä¹‰å¦‚ä¸‹:

```C#
public interface IUserAction {
    void restart();
    void ToggleBoat();
    void ClickCharacter(ICharacterController chracter);
}
```
---
### UserGUI
UserGUIçš„ä»£ç å¦‚ä¸‹:

```C#
public class UserGUI : MonoBehaviour {
    public int status = 0;
    private IUserAction action;
    GUIStyle headerStyle;
    GUIStyle buttonStyle;

	// Use this for initialization
	void Start () {
        action = GameDirector.getInstance().currentSceneController as IUserAction;
        headerStyle = new GUIStyle();
        headerStyle.fontSize = 40;
        headerStyle.alignment = TextAnchor.MiddleCenter;
        buttonStyle = new GUIStyle("button");
        buttonStyle.fontSize = 30;
    }
	
	// Update is called once per frame
	void OnGUI () {
        GUI.Label(new Rect(Screen.width / 2 - 100, 10, 200, 50), "Priests & Demons", headerStyle);
        if (status == 1)
        {
            GUI.Label(new Rect(Screen.width / 2 - 45, Screen.height / 2 - 90, 100, 50), "Gameover!", headerStyle);
            if (GUI.Button(new Rect(Screen.width / 2 - 65, Screen.height / 2, 140, 70), "Restart", buttonStyle))
            {
                status = 0;
                action.restart();
            }
        }
        else if (status == 2)
        {
            GUI.Label(new Rect(Screen.width / 2 - 50, Screen.height / 2 - 90, 100, 50), "Win!", headerStyle);
            if (GUI.Button(new Rect(Screen.width / 2 - 70, Screen.height / 2, 140, 70), "Restart", buttonStyle))
            {
                status = 0;
                action.restart();
            }
        }
    }
}
```
ç”±ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒUserGUIåªæ˜¯ç®€å•åœ°æ ¹æ®æ¸¸æˆçŠ¶æ€ï¼Œå¯¹æ¸¸æˆä¿¡æ¯ç­‰è¿›è¡Œå±•ç¤ºï¼Œç„¶åé€šè¿‡IUserActionä¸Controllerè¿›è¡Œäº¤äº’ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢æ‰€æåˆ°çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨GUIä¸­è°ƒç”¨IUserActionä¸­çš„æ–¹æ³•å°±å¯ä»¥è¿…é€Ÿå®ç°å¯¹æ¸¸æˆåœºæ™¯çš„æ§åˆ¶ï¼Œä¸‹é¢çš„ClickGUIä¹Ÿæ˜¯ä¸€æ ·

---
### ClickGUI
è¯¥ç±»çš„ä»£ç å¦‚ä¸‹:

```c#
public class ClickGUI : MonoBehaviour {
    IUserAction action;
    ICharacterController character;

    public void setController(ICharacterController characterController)
    {
        character = characterController;
    }

    void Start()
    {
        action = GameDirector.getInstance().currentSceneController as IUserAction;
    }

    void OnMouseDown()
    {
        if (gameObject.name == "boat")
        {
            action.ToggleBoat();
        }
        else
        {
            action.ClickCharacter(character);
        }
    }
}
```
åœ¨ClickGUIä¸­ï¼Œæˆ‘ä»¬åŒæ ·ç”¨åˆ°äº†IUserAction, ClickGUIç›‘å¬äº‹ä»¶çš„å‘ç”Ÿï¼Œç„¶åé€šè¿‡IUserActionæä¾›çš„ç±»ä¼¼ç§»åŠ¨èˆ¹ï¼Œæ¸¸æˆè§’è‰²ä¸Šä¸‹èˆ¹çš„å‡½æ•°ï¼ŒæŠŠç”¨æˆ·æŒ‡ä»¤ä¼ ç»™Controllerè¿›è¡Œæ‰§è¡Œã€‚ä»è€Œå®ç°Viewå’ŒControllerä¹‹é—´çš„äº¤äº’ã€‚

---
### FirstController
åœ¨è¯¥æ¸¸æˆä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ¸¸æˆåœºæ™¯ï¼Œæ‰€ä»¥

å…¶ä»£ç å®ç°å¦‚ä¸‹:

```C#
public class FirstController : MonoBehaviour, ISceneController, IUserAction {
    readonly Vector3 riverPosition = new Vector3(0, -0.25f, 0);
    UserGUI userGUI;

    public LandController rightLand;
    public LandController leftLand;
    public BoatController boat;
    public ICharacterController[] characters;

    void Awake()
    {
        GameDirector director = GameDirector.getInstance();
        director.currentSceneController = this;
        userGUI = gameObject.AddComponent<UserGUI>() as UserGUI;
        genGameObjects();
    }

    public void genGameObjects()
    {
        characters = new ICharacterController[6];
        GameObject river = Instantiate(Resources.Load("Prefabs/River", typeof(GameObject)), riverPosition, Quaternion.identity, null) as GameObject;
        river.name = "river";

        boat = new BoatController();
        leftLand = new LandController(-1);
        rightLand = new LandController(1);

        for (int i = 0; i < 3; i++)
        {
            ICharacterController priest = new ICharacterController(0, "priest" + i);
            priest.setPosition(rightLand.getEmptyPosition());
            priest.getOnLand(rightLand);
            rightLand.getOnLand(priest);
            characters[i] = priest;
        }

        for (int i = 0; i < 3; i++)
        {
            ICharacterController demon = new ICharacterController(1, "demon" + i);
            demon.setPosition(rightLand.getEmptyPosition());
            demon.getOnLand(rightLand);
            rightLand.getOnLand(demon);
            characters[i+3] = demon;
        }
    }


    public void ClickCharacter(ICharacterController character)
    {
        if (userGUI.status != 0 || !boat.available())
        {
            return;
        }
        if (character.isOnBoat()) {
            LandController land;
            if (boat.getBoatPos() == 0)
            {
                land = leftLand;
            }
            else
            {
                land = rightLand;
            }
            boat.getOffBoat(character.getName());
            character.MoveTo(land.getEmptyPosition());
            character.getOnLand(land);
            land.getOnLand(character);
        }
        else
        {
            LandController land = character.getLandController();
            if (boat.getEmptyIndex() == -1)
                return;
            int landPos = land.getType(), boatPos = (boat.getBoatPos() == 0) ? -1 : 1;
            if (landPos != boatPos)
                return;
            land.getOffLand(character.getName());
            character.MoveTo(boat.getEmptyPosition());
            character.getOnBoat(boat, boat.getEmptyIndex());
            boat.getOnBoat(character);
        }
        userGUI.status = checkResult();
    }

    public void ToggleBoat()
    {
        if (userGUI.status != 0 || boat.isEmptty())
            return;
        boat.Move();
        userGUI.status = checkResult();
    }

    int checkResult()
    {
        int leftPriests = 0;
        int rightPriests = 0;
        int leftDemons = 0;
        int rightDemons = 0;

        int[] leftStatus = leftLand.getStatus();
        leftPriests += leftStatus[0];
        leftDemons += leftStatus[1];

        if (leftPriests + leftDemons == 6)
            return 2;

        int[] rightStatus = rightLand.getStatus();
        rightPriests += rightStatus[0];
        rightDemons += rightStatus[1];

        int[] boatStatus = boat.getBoatStatus();
        if (boat.getBoatPos() == 0)
        {
            leftPriests += boatStatus[0];
            leftDemons += boatStatus[1];
        }
        else
        {
            rightPriests += boatStatus[0];
            rightDemons += boatStatus[1];
        }

        if (leftPriests > 0 && leftPriests < leftDemons)
            return 1;
        if (rightPriests > 0 && rightPriests < rightDemons)
            return 1;

        return 0;
    }

    public void restart()
    {
        boat.reset();
        leftLand.reset();
        rightLand.reset();
        for (int i = 0; i < characters.Length; i++)
            characters[i].reset();
    }
}

```

FirstControllerç»§æ‰¿äº†ISceneControllerå’ŒIUserActionè¿™ä¸¤ä¸ªæ¥å£ï¼Œå¹¶å®ç°äº†å…¶é‡Œé¢çš„å‡½æ•°ï¼Œå…¶æ—¢å¯ä»¥é€šè¿‡IUserActionä¸Viewè¿›è¡Œäº¤äº’ï¼Œä¹Ÿå¯ä»¥åœ¨LoadResourcesåï¼Œé€šè¿‡GameObjectçš„Controllerå¯¹åœºæ™¯ä¸­çš„å„ä¸ªGameObjectè¿›è¡Œæ§åˆ¶ã€‚

---
ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»æ¸¸æˆä¸­æ¸¸æˆå¯¹è±¡çš„Controllerçš„ä¹¦å†™

é¦–å…ˆï¼Œè´¯ç©¿ç€æˆ‘ä»¬è¿™æ•´ä¸€ä¸ªæ¸¸æˆçš„å°±æ˜¯GameObjectçš„ç§»åŠ¨å•¦ï¼æ‰€ä»¥æˆ‘å…ˆè¯´ä¸€ä¸‹æŠ½è±¡å‡ºæ¥çš„Moveç±»ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š

```C#
public class Move : MonoBehaviour {
    readonly float speed = 20;

    int status;//0: é™æ­¢, 1: å¤„äºå‰æ®µç§»åŠ¨, 2: å¤„äºåæ®µç§»åŠ¨
    Vector3 middle;
    Vector3 destination;

    void Update()
    {
        if (status == 1)
        {
            this.transform.position = Vector3.MoveTowards(this.transform.position, middle, Time.deltaTime * speed);
            if (transform.position == middle)
            {
                status = 2;
            }
        }
        else if (status == 2)
        {
            this.transform.position = Vector3.MoveTowards(this.transform.position, destination, Time.deltaTime * speed);
            if (this.transform.position == destination)
            {
                status = 0;
            }
        }
    }

    public int getStatus()
    {
        return status;
    }

    public  void moveTo(Vector3 _destination)
    {
        destination = _destination;
        middle = _destination;
        if (_destination.y == this.transform.position.y)
        {
            status = 2;
            return;
        }
        else if (_destination.y < this.transform.position.y)
        {
            middle.y = transform.position.y;
        }
        else
        {
            middle.x = transform.position.x;
        }
        status = 1;
    }

    public void reset()
    {
        status = 0;
    }
}
```
ä¸ºäº†è®©ç‰©ä½“ä¸è¦ç›´æ¥ç©¿è¿‡landçš„å¢™ä½“ï¼Œå½“characterä¸Šèˆ¹æ—¶ï¼Œå…ˆæŠŠç‰©ä½“ç§»åŠ¨åˆ°destinationçš„å¯¹åº”çš„xåæ ‡ï¼Œç„¶åå†æŠŠç‰©ä½“ç§»åŠ¨åˆ°å¯¹åº”çš„ä½ç½®ï¼Œå½“charcterä¸‹èˆ¹æ—¶ï¼Œå…ˆæŠŠç‰©ä½“ç§»åŠ¨åˆ°destinationçš„å¯¹åº”çš„yåæ ‡ï¼Œç„¶åå†æŠŠç‰©ä½“ç§»åŠ¨åˆ°å¯¹åº”çš„ä½ç½®,è¿™æ ·ä¿è¯äº†ç‰©ä½“ä¸ä¼šç©¿è¶Šå¢™ä½“è¿›è¡Œç§»åŠ¨ï¼Œä¸”å®ç°æ–¹å¼è¾ƒä¸ºç®€å•ã€‚

### ICharacterController
å› ä¸ºç‰§å¸ˆä¸æ¶é­”çš„åŠ¨ä½œç­‰éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±åªæ˜¯å¤–å½¢ã€ç±»å‹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘æŠŠå…¶æŠ½è±¡ä¸ºä¸€ä¸ªController,é€šè¿‡typeåŒºåˆ†å®ƒä»¬
å…¶ä»£ç å¦‚ä¸‹:

```C#
public class ICharacterController
{
    readonly GameObject character;
    readonly Move moveAction;
    readonly int type;//0: Priest, 1: Demon
    readonly ClickGUI clickGUI;

    bool onBoat;
    LandController landController;

    public ICharacterController(int chracterType, string name)
    {
        if (chracterType == 0)
        {
            this.character = Object.Instantiate(Resources.Load("Prefabs/Priest", typeof(GameObject)), Vector3.zero, Quaternion.identity, null) as GameObject;
            this.type = 0;
        }
        else
        {
            this.character = Object.Instantiate(Resources.Load("Prefabs/Demon", typeof(GameObject)), Vector3.zero, Quaternion.identity, null) as GameObject;
            this.type = 1;
        }
        character.name = name;
        moveAction = character.AddComponent(typeof(Move)) as Move;
        clickGUI = character.AddComponent(typeof(ClickGUI)) as ClickGUI;
        clickGUI.setController(this);
    }

    public string getName()
    {
        return character.name;
    }

    public void setPosition(Vector3 pos)
    {
        character.transform.position = pos;
    }

    public void MoveTo(Vector3 destination)
    {
        moveAction.moveTo(destination);
    }

    public int getType()
    {
        return type;
    }

    public void getOnBoat(BoatController boatController, int pos)
    {
        landController = null;
        if (pos == 0)
        {
            character.transform.rotation = Quaternion.AngleAxis(90, Vector3.up);
        }
        else
        {
            character.transform.rotation = Quaternion.AngleAxis(270, Vector3.up);
        }
        character.transform.parent = boatController.getBoat().transform;
        onBoat = true;
    }

    public void getOnLand(LandController land)
    {
        landController = land;
        if (land.getType() == -1)
        {
            character.transform.rotation = Quaternion.AngleAxis(90, Vector3.up);
        }
        else
        {
            character.transform.rotation = Quaternion.AngleAxis(270, Vector3.up);
        }
        character.transform.parent = null;
        onBoat = false;
    }

    public bool isOnBoat()
    {
        return onBoat;
    }

    public LandController getLandController()
    {
        return landController;
    }

    public void reset()
    {
        moveAction.reset();
        landController = (GameDirector.getInstance().currentSceneController as FirstController).rightLand;
        getOnLand(landController);
        setPosition(landController.getEmptyPosition());
        landController.getOnLand(this);
    }
}
```
CharcterControllerç±»çš„å®ç°ååˆ†ç®€å•ï¼Œå°±æ˜¯æ ¹æ®typeå¯¼å…¥é¢„åˆ¶ï¼Œç„¶åå†å®ç°ä¸Šèˆ¹ï¼Œä¸Šå²¸ï¼Œé‡ç½®ä»¥åŠä¸€äº›å…¶ä»–çš„get, setå‡½æ•°å°±å®Œæˆäº†ï¼Œå…·ä½“å¯ä»¥çœ‹ä»¥ä¸Šä»£ç çš„å®ç°ã€‚

### BoatController
BoatControllerç±»çš„ä»£ç å¦‚ä¸‹:

```C#
public class BoatController {
    readonly GameObject boat;
    readonly Move moveAction;
    readonly Vector3 right = new Vector3(3.5f, 0, 0);
    readonly Vector3 left = new Vector3(-3.5f, 0, 0);
    readonly Vector3[] right_positions;
    readonly Vector3[] left_positions;

    int status;// 0: left, 1: right
    ICharacterController[] characterOnBoat = new ICharacterController[2];

    public BoatController()
    {
        status = 1;
        right_positions = new Vector3[] { new Vector3(2.5F, 0.2F, 0), new Vector3(4.5F, 0.2F, 0) };
        left_positions = new Vector3[] { new Vector3(-4.5F, 0.2F, 0), new Vector3(-2.5F, 0.2F, 0) };
        boat = Object.Instantiate(Resources.Load("Prefabs/Boat", typeof(GameObject)), right, Quaternion.identity, null) as GameObject;
        boat.name = "boat";
        moveAction = boat.AddComponent(typeof(Move)) as Move;
        boat.AddComponent(typeof(ClickGUI));
    }

    public void Move()
    {
        if (status == 1)
        {
            moveAction.moveTo(left);
        }
        else
        {
            moveAction.moveTo(right);
        }
        status = 1 - status;
    }

    public int getEmptyIndex()
    {
        for (int i = 0; i < characterOnBoat.Length; i++)
        {
            if (characterOnBoat[i] == null)
            {
                return i;
            }
        }
        return -1;
    }

    public Vector3 getEmptyPosition()
    {
        int index = getEmptyIndex();
        if (status == 0)
        {
            return left_positions[index];
        }
        else
        {
            return right_positions[index];
        }
    }

    public bool isEmptty()
    {
        for (int i = 0; i < characterOnBoat.Length; i++)
        {
            if (characterOnBoat[i] != null)
            {
                return false;
            }
        }
        return true;
    }

    public void getOnBoat(ICharacterController character)
    {
        characterOnBoat[getEmptyIndex()] = character;
    }

    public ICharacterController getOffBoat(string name)
    {
        for (int i = 0; i < characterOnBoat.Length; i++)
        {
            if (characterOnBoat[i] != null && characterOnBoat[i].getName() == name)
            {
                ICharacterController character = characterOnBoat[i];
                characterOnBoat[i] = null;
                return character;
            }
        }
        return null;
    }

    public GameObject getBoat()
    {
        return boat;
    }

    public int getBoatPos()
    {
        return status;
    }

    public int[] getBoatStatus()
    {
        int[] boatStatus = { 0, 0 };
        for (int i = 0; i < characterOnBoat.Length; i++)
        {
            if (characterOnBoat[i] == null)
                continue;
            boatStatus[characterOnBoat[i].getType()]++;
        }
        return boatStatus;
    }// 0: Priests, 1: Demon

    public bool available()
    {
        return (moveAction.getStatus() == 0);
    }

    public void reset()
    {
        moveAction.reset();
        if (status == 0)
        {
            Move();
        }
        characterOnBoat = new ICharacterController[2];
    }
}
```
Boatçš„å®ç°ä¹Ÿå·®ä¸å¤šï¼Œåªéœ€è¦å®ç°åˆå§‹åŒ–ã€ç§»åŠ¨(ToggleBoat),characterä¸Šèˆ¹ã€ä¸‹èˆ¹ç›¸å…³çš„å‡½æ•°å°±å¯ä»¥å®ç°äº†ã€‚

### LandController
LandControllerç±»çš„ä»£ç å¦‚ä¸‹:

```C#
public class LandController {
    readonly GameObject land;
    readonly Vector3 leftPos = new Vector3(-8.5f, 0f, 0f);
    readonly Vector3 rightPos = new Vector3(8.5f, 0f, 0f);
    readonly Vector3[] landPositions;
    readonly int type;// 1:right, -1: left

    ICharacterController[] characterOnLand;

    public LandController(int _type)
    {
        landPositions = new Vector3[] { new Vector3(6F,0.5F,0), new Vector3(7F,0.5F,0), new Vector3(8F,0.5F,0),
                new Vector3(9F,0.5F,0), new Vector3(10F,0.5F,0), new Vector3(11F,0.5F,0) };

        characterOnLand = new ICharacterController[6];

        type = _type;
        if (type == 1)
        {
            land = Object.Instantiate(Resources.Load("Prefabs/Land", typeof(GameObject)), rightPos, Quaternion.identity, null) as GameObject;
            land.name = "rightLand";
        }
        else
        {
            land = Object.Instantiate(Resources.Load("Prefabs/Land", typeof(GameObject)), leftPos, Quaternion.identity, null) as GameObject;
            land.name = "leftLand";
        }
    }

    public Vector3 getEmptyPosition()
    {
        Vector3 pos = landPositions[getEmptyIndex()];
        pos.x *= type;
        return pos;
    }

    public int getEmptyIndex()
    {
        for (int i = 0; i < characterOnLand.Length; i++)
        {
            if (characterOnLand[i] == null)
                return i;
        }
        return -1;
    }

    public void getOnLand(ICharacterController chracter)
    {
        characterOnLand[getEmptyIndex()] = chracter;
    }

    public ICharacterController getOffLand(string name)
    {
        for (int i = 0; i < characterOnLand.Length; i++)
        {
            if (characterOnLand[i] != null && characterOnLand[i].getName() == name)
            {
                ICharacterController tmp = characterOnLand[i];
                characterOnLand[i] = null;
                return tmp;
            }
        }
        return null;
    }

    public int getType()
    {
        return type;
    }

    public int[] getStatus()
    {
        int[] status = { 0, 0 };
        for (int i = 0; i < characterOnLand.Length; i++)
        {
            if (characterOnLand[i] == null)
                continue;
            status[characterOnLand[i].getType()]++;
        }
        return status;
    }// 0: priests, 1: Demon

    public void reset()
    {
        characterOnLand = new ICharacterController[6];
    }
}
```
landControllerçš„å®ç°å’Œä¸Šé¢çš„Controllerä¹Ÿç±»ä¼¼ï¼Œä¹Ÿæ˜¯å®ç°åˆå§‹åŒ–ï¼Œä¸Šå²¸ï¼Œä¸‹å²¸çš„ç›¸å…³å‡½æ•°å°±å®Œæˆäº†ã€‚

---
## æ€»ç»“ï¼ˆå¯¹MVCæ¶æ„å¼€å‘æ¸¸æˆçš„ä½“ä¼šï¼‰


MVCæ¶æ„ä½œä¸ºä¸€ç§ç»å…¸çš„å¼€å‘æ¨¡å¼ï¼Œæ˜¯å…³æ³¨ç‚¹åˆ†ç¦»çš„ä¸€ä¸ªååˆ†ç»å…¸çš„ä½“ç°ã€‚æˆ‘ä»¬åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œåœ¨å®Œæˆä¸€äº›å›¢é˜Ÿé¡¹ç›®æ—¶ä¹Ÿæœ‰ä½¿ç”¨å…¶ä½œä¸ºåŸºæœ¬æ¶æ„è¿›è¡Œå¼€å‘ã€‚

é¡¹ç›®ä½¿ç”¨MVCæ¶æ„åˆ†ç¦»çš„è®¾è®¡ï¼Œ**ç»™æ¯ä¸€ä¸ªéƒ¨åˆ†èµ‹äºˆå•ä¸€çš„èŒè´£**ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªæ¨¡å—æ—¶ä¸ç”¨å¤ªå¤šåœ°å…³æ³¨æ‰€ä½¿ç”¨åˆ°çš„æ¨¡å—çš„å†…éƒ¨å®ç°ï¼Œæˆ‘ä»¬åªéœ€è¦å»è°ƒç”¨ç›¸åº”çš„æ¥å£å»å®ç°è‡ªå·±æƒ³å®ç°çš„ä¸œè¥¿ï¼Œ**ä½¿å¾—æˆ‘ä»¬çš„æ¸¸æˆæœ‰ç€æ›´ä½çš„è€¦åˆåº¦ï¼Œæ›´æ–¹ä¾¿Debugï¼Œæ›´æ–¹ä¾¿å¼€å‘ã€è¿­ä»£**ï¼Œå°±ä»¥æˆ‘ä»¬ä¸Šé¢çš„ç¨‹åºä¸ºä¾‹ï¼Œåœ¨å¼€å‘FirstSceneControlleræ—¶ï¼Œæˆ‘ä»¬ä¸ç”¨æ€ä¹ˆå…³æ³¨GameObjectçš„Controllerå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œå®ƒç»™äº†æˆ‘ä»¬ä»€ä¹ˆæ¥å£ï¼Œè¿™ä¸ªæ¥å£æœ‰ç€ä»€ä¹ˆåŠŸèƒ½ï¼ŒçŸ¥é“äº†ä¹‹åæˆ‘ä»¬åœ¨FirstSceneControllerä¸­ç›´æ¥è°ƒç”¨æ¥å£å°±å¯ä»¥äº†ï¼Œè¿™ä¸ä»…è®©ä¸ªäººå¼€å‘æ›´æœ‰æ¡ç†ï¼Œè¿˜å¯ä»¥ä½¿å¤šäººåä½œå¼€å‘æ›´åŠ ä¾¿åˆ©ï¼Œéš¾ä»¥æƒ³è±¡ä¸€ä¸ªé«˜è€¦åˆåº¦çš„ä¸­å¤§å‹è½¯ä»¶æ˜¯æ€ä¹ˆè¿›è¡Œå¤šäººåä½œå¼€å‘çš„ï¼Œè¿™æ ·çš„è½¯ä»¶ä¸€ä¸ªäººå¼€å‘éƒ½éš¾å—ï¼Œä½•å†µæ˜¯å¤šäººã€‚

æ€»ä¹‹ï¼Œåœ¨ä¸€äº›ä¸­å¤§å‹é¡¹ç›®ä¸­ï¼Œä½¿ç”¨MVCæ¶æ„è¿›è¡Œå¼€å‘

* è½¯ä»¶è€¦åˆåº¦ä½
* æ¨¡å—æ˜“å¤ç”¨
* ç”Ÿäº§æ•ˆç‡é«˜(å¯¹äºä¸­å¤§å‹è½¯ä»¶) 
* æ˜“äºç»´æŠ¤ã€è¿­ä»£
* æœ‰åˆ©è½¯ä»¶å·¥ç¨‹åŒ–ç®¡ç†

> ä½†æ˜¯ï¼ŒMVCæ¶æ„ä¸æ˜¯æ™®é€‚çš„ï¼Œåœ¨ä¸€äº›è¾ƒå°è§„æ¨¡çš„æ¸¸æˆä¸­ï¼Œä¸¥æ ¼ä½¿ç”¨MVCæ¶æ„å¯¹äºå¼€å‘çš„æ•ˆç‡æ˜¯æœ‰ä¸€å®šå½±å“çš„ï¼Œå°±åƒæˆ‘ä»¬è¿™æ¬¡çš„ä½œä¸šğŸŒš(é€ƒã€‚ä¸è¿‡ï¼Œé€šè¿‡è¿™ä¸€æ¬¡ä¸¥æ ¼ä½¿ç”¨MVCæ¶æ„å¼€å‘çš„ä½œä¸šï¼Œæˆ‘ä»¬å¯¹äºMVCæœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œæ–¹ä¾¿äº†æˆ‘ä»¬ä¹‹åä½¿ç”¨MVCæ¶æ„å¯¹å…¶ä»–ä¸€äº›æ›´å¤§çš„æ¸¸æˆè¿›è¡Œå¼€å‘ã€‚


